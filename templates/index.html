<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pill Counter</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #f0f2f5;
      --surface:     #ffffff;
      --surface-2:   #f7f8fa;
      --border:      #d1d5db;
      --border-2:    #b0b7c3;
      --text:        #111827;
      --text-muted:  #6b7280;
      --text-light:  #9ca3af;
      --accent:      #1d4ed8;
      --accent-hover:#1e40af;
      --accent-light:#eff6ff;
      --accent-mid:  #bfdbfe;
      --success:     #15803d;
      --danger:      #b91c1c;
      --danger-bg:   #fef2f2;
      --danger-border:#fecaca;
      --radius:      8px;
      --radius-lg:   12px;
      --shadow:      0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md:   0 4px 6px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem 4rem;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Header ── */
    header {
      text-align: center;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-mark {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 10px;
      flex-shrink: 0;
    }

    .logo-mark svg { width: 20px; height: 20px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .header-text h1 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.01em;
      text-align: left;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.78rem;
      margin-top: 0.1rem;
      text-align: left;
    }

    /* ── Main card ── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      width: 100%;
      max-width: 560px;
      box-shadow: var(--shadow);
    }

    /* ── Section label ── */
    .section-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.6rem;
    }

    /* ── Source row ── */
    .source-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 1rem;
    }

    /* ── Shared source tile ── */
    .source-tile {
      border: 1.5px dashed var(--border-2);
      border-radius: var(--radius);
      background: var(--surface-2);
      min-height: 100px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: border-color 0.12s, background 0.12s, box-shadow 0.12s;
      cursor: pointer;
    }

    .source-tile:hover {
      border-color: var(--accent);
      background: var(--accent-light);
      box-shadow: 0 0 0 3px var(--accent-mid);
    }

    .source-tile.active {
      border-style: solid;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-mid);
    }

    .source-tile.active:hover { background: var(--surface-2); }

    .tile-idle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
      pointer-events: none;
    }

    .tile-idle svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-muted);
    }

    .tile-idle span {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text);
    }

    .tile-idle small {
      font-size: 0.68rem;
      color: var(--text-light);
      margin-top: -0.2rem;
    }

    .tile-file-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .tile-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .source-tile.active .tile-preview { display: block; }
    .source-tile.active .tile-idle    { display: none; }

    /* ── Camera ── */
    .tile-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .source-tile.camera-live .tile-video { display: block; }
    .source-tile.camera-live .tile-idle  { display: none; }

    .capture-btn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid #fff;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.12s;
    }

    .capture-btn:hover { background: rgba(0,0,0,0.5); }
    .capture-btn::after {
      content: '';
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
    }

    .source-tile.camera-live .capture-btn { display: flex; }

    .retake-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      padding: 2px 7px;
      font-size: 0.65rem;
      font-weight: 700;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: none;
      backdrop-filter: blur(4px);
      letter-spacing: 0.03em;
    }

    .source-tile.active .retake-btn { display: block; }

    /* ── Inset divider ── */
    .inset-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 1rem 0;
    }

    /* ── Demo strip (horizontal scroll) ── */
    .demo-strip-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--border-2) transparent;
      padding-bottom: 4px;
      margin-bottom: 0;
    }

    .demo-strip-wrap::-webkit-scrollbar       { height: 4px; }
    .demo-strip-wrap::-webkit-scrollbar-track  { background: transparent; }
    .demo-strip-wrap::-webkit-scrollbar-thumb  { background: var(--border-2); border-radius: 2px; }

    .demo-strip { display: flex; gap: 6px; width: max-content; }

    .demo-thumb {
      width: 52px;
      height: 52px;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid var(--border);
      cursor: pointer;
      background: var(--surface-2);
      position: relative;
      transition: border-color 0.12s, box-shadow 0.12s;
      flex-shrink: 0;
    }

    .demo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: opacity 0.12s;
    }

    .demo-thumb:hover            { border-color: var(--accent); }
    .demo-thumb:hover img        { opacity: 0.85; }

    .demo-thumb.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-mid);
    }

    .demo-thumb.selected::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(29,78,216,0.1);
      pointer-events: none;
    }

    .check-mark {
      display: none;
      position: absolute;
      top: 3px;
      right: 3px;
      width: 15px;
      height: 15px;
      background: var(--accent);
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    .demo-thumb.selected .check-mark { display: flex; }
    .check-mark svg { width: 8px; height: 8px; stroke: #fff; stroke-width: 2.5; fill: none; }

    .demo-empty {
      color: var(--text-muted);
      font-size: 0.78rem;
      padding: 0.75rem 0;
    }

    /* ── Submit button ── */
    #submit-btn {
      width: 100%;
      margin-top: 1rem;
      padding: 0.7rem;
      font-size: 0.88rem;
      font-weight: 700;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: background 0.12s, box-shadow 0.12s;
      letter-spacing: 0.01em;
    }

    #submit-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      box-shadow: 0 2px 8px rgba(29,78,216,0.3);
    }

    #submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .spinner {
      display: none;
      width: 15px;
      height: 15px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.65s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Error ── */
    .error-box {
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      border-radius: var(--radius);
      padding: 0.6rem 0.85rem;
      color: var(--danger);
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 0.75rem;
      display: none;
    }

    /* ── Result ── */
    #result { display: none; width: 100%; max-width: 560px; margin-top: 1.25rem; }

    /* Big count banner */
    .count-banner {
      background: var(--accent);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    .count-number {
      font-size: 3.5rem;
      font-weight: 900;
      line-height: 1;
      color: #fff;
      letter-spacing: -0.04em;
    }

    .count-right { color: rgba(255,255,255,0.85); }

    .count-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.2rem;
    }

    .count-sublabel {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.7);
    }

    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow);
    }

    .annotated-wrap {
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    #annotated-img { width: 100%; display: block; }

    /* ── Pill strip ── */
    .pill-strip-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--border-2) transparent;
      padding-bottom: 4px;
    }

    .pill-strip-wrap::-webkit-scrollbar       { height: 4px; }
    .pill-strip-wrap::-webkit-scrollbar-track  { background: transparent; }
    .pill-strip-wrap::-webkit-scrollbar-thumb  { background: var(--border-2); border-radius: 2px; }

    .pill-strip { display: flex; gap: 8px; width: max-content; }

    .pill-thumb { flex-shrink: 0; }

    .pill-thumb-img-wrap {
      width: 64px;
      height: 64px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--surface-2);
    }

    .pill-thumb-img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .pill-conf {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
      margin-top: 3px;
    }

    canvas { display: none; }
  </style>
</head>
<body>

  <header>
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="9"/>
        <path d="M12 3 A9 9 0 0 1 21 12 L3 12 A9 9 0 0 1 12 3Z" fill="rgba(255,255,255,0.25)" stroke="none"/>
        <line x1="6.5" y1="12" x2="17.5" y2="12"/>
      </svg>
    </div>
    <div class="header-text">
      <h1>Pill Counter</h1>
      <p class="subtitle">AI-powered detection &amp; counting</p>
    </div>
  </header>

  <div class="card">
    <div class="section-label">Image source</div>
    <div class="source-row">

      <!-- Upload tile -->
      <div class="source-tile" id="upload-tile">
        <input type="file" class="tile-file-input" id="file-input" accept="image/*" />
        <img class="tile-preview" id="upload-preview" alt="Upload preview" />
        <button class="retake-btn" id="upload-retake">✕ Remove</button>
        <div class="tile-idle">
          <svg fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M3 15v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4"/>
            <polyline points="7 10 12 5 17 10"/>
            <line x1="12" y1="5" x2="12" y2="15"/>
          </svg>
          <span>Upload</span>
          <small>or drag &amp; drop</small>
        </div>
      </div>

      <!-- Camera tile -->
      <div class="source-tile" id="camera-tile">
        <video id="video" autoplay playsinline muted class="tile-video"></video>
        <button class="capture-btn" id="capture-btn" title="Capture"></button>
        <img class="tile-preview" id="snapshot-preview" alt="Captured frame" />
        <button class="retake-btn" id="camera-retake">↺ Retake</button>
        <div class="tile-idle">
          <svg fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          <span>Camera</span>
          <small>tap to open</small>
        </div>
      </div>

    </div>

    <!-- Demo images -->
    <hr class="inset-divider" />
    <div class="section-label">Demo samples</div>
    <div class="demo-strip-wrap">
      <div class="demo-strip" id="demo-grid">
        <div class="demo-empty">Loading…</div>
      </div>
    </div>

    <button id="submit-btn" disabled>
      <span id="btn-label">Analyze Image</span>
      <div class="spinner" id="spinner"></div>
    </button>

    <div class="error-box" id="error-box"></div>
  </div>

  <!-- Result -->
  <div id="result">
    <div class="count-banner">
      <div class="count-number" id="count-number">0</div>
      <div class="count-right">
        <div class="count-label" id="count-label">pills detected</div>
        <div class="count-sublabel" id="result-meta"></div>
      </div>
    </div>
    <div class="result-card">
      <div class="section-label">Annotated image</div>
      <div class="annotated-wrap">
        <img id="annotated-img" src="" alt="Annotated result" />
      </div>

      <div id="pill-strip-section" style="display:none">
        <div class="section-label">Detected pills</div>
        <div class="pill-strip-wrap">
          <div class="pill-strip" id="pill-strip"></div>
        </div>
      </div>
    </div>
  </div>

  <canvas id="snap-canvas"></canvas>
  <canvas id="crop-canvas"></canvas>

  <script>
    // ── State ───────────────────────────────────────────────
    let activeSource = null; // 'upload' | 'camera' | 'demo'
    let uploadedFile = null;
    let capturedBlob = null;
    let demoBlob     = null;
    let stream       = null;

    // ── Upload tile ─────────────────────────────────────────
    const uploadTile    = document.getElementById('upload-tile');
    const fileInput     = document.getElementById('file-input');
    const uploadPreview = document.getElementById('upload-preview');
    const uploadRetake  = document.getElementById('upload-retake');

    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) applyUpload(fileInput.files[0]);
    });

    uploadTile.addEventListener('dragover', e => { e.preventDefault(); uploadTile.classList.add('dragover'); });
    uploadTile.addEventListener('dragleave', () => uploadTile.classList.remove('dragover'));
    uploadTile.addEventListener('drop', e => {
      e.preventDefault();
      uploadTile.classList.remove('dragover');
      const f = e.dataTransfer.files[0];
      if (f && f.type.startsWith('image/')) applyUpload(f);
    });

    uploadRetake.addEventListener('click', e => {
      e.stopPropagation();
      clearUpload();
      clearSubmit();
    });

    function applyUpload(f) {
      clearCamera();
      clearDemo();
      uploadedFile = f;
      uploadPreview.src = URL.createObjectURL(f);
      uploadTile.classList.add('active');
      setActiveSource('upload');
    }

    function clearUpload() {
      uploadedFile = null;
      uploadPreview.src = '';
      fileInput.value = '';
      uploadTile.classList.remove('active');
    }

    // ── Camera tile ─────────────────────────────────────────
    const cameraTile    = document.getElementById('camera-tile');
    const video         = document.getElementById('video');
    const captureBtn    = document.getElementById('capture-btn');
    const snapPreview   = document.getElementById('snapshot-preview');
    const cameraRetake  = document.getElementById('camera-retake');
    const snapCanvas    = document.getElementById('snap-canvas');

    cameraTile.addEventListener('click', e => {
      if (e.target === cameraRetake || e.target === captureBtn) return;
      if (cameraTile.classList.contains('camera-live')) return;
      if (cameraTile.classList.contains('active')) return;
      startCamera();
    });

    captureBtn.addEventListener('click', e => {
      e.stopPropagation();
      doCapture();
    });

    cameraRetake.addEventListener('click', e => {
      e.stopPropagation();
      clearCapture();
      startCamera();
    });

    async function startCamera() {
      clearUpload();
      clearDemo();
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
        cameraTile.classList.add('camera-live');
        cameraTile.classList.remove('active');
      } catch (err) {
        showError('Camera access denied: ' + err.message);
      }
    }

    function doCapture() {
      snapCanvas.width  = video.videoWidth;
      snapCanvas.height = video.videoHeight;
      snapCanvas.getContext('2d').drawImage(video, 0, 0);
      snapCanvas.toBlob(blob => {
        capturedBlob = blob;
        snapPreview.src = URL.createObjectURL(blob);
        stopStream();
        cameraTile.classList.remove('camera-live');
        cameraTile.classList.add('active');
        setActiveSource('camera');
      }, 'image/jpeg', 0.92);
    }

    function stopStream() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
      }
    }

    function clearCapture() {
      capturedBlob = null;
      snapPreview.src = '';
      cameraTile.classList.remove('active', 'camera-live');
      stopStream();
    }

    function clearCamera() { clearCapture(); }

    // ── Demo images ─────────────────────────────────────────
    const demoGrid = document.getElementById('demo-grid');

    async function loadDemoImages() {
      try {
        const resp = await fetch('/demo-images');
        const data = await resp.json();
        demoGrid.innerHTML = '';
        if (!data.images || data.images.length === 0) {
          demoGrid.innerHTML = '<div class="demo-empty">No demo images — add files to <code>public/demo_images/</code></div>';
          return;
        }
        data.images.forEach(url => {
          const wrap  = document.createElement('div');
          wrap.className = 'demo-thumb';

          const img   = document.createElement('img');
          img.src     = url;
          img.alt     = url.split('/').pop();
          img.loading = 'lazy';

          const check = document.createElement('div');
          check.className = 'check-mark';
          check.innerHTML = `<svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3"/></svg>`;

          wrap.appendChild(img);
          wrap.appendChild(check);
          wrap.addEventListener('click', () => selectDemo(url, wrap));
          demoGrid.appendChild(wrap);
        });
      } catch {
        demoGrid.innerHTML = '<div class="demo-empty">Failed to load demo images.</div>';
      }
    }

    async function selectDemo(url, thumbEl) {
      clearUpload();
      clearCamera();
      clearDemoSelection();
      thumbEl.classList.add('selected');
      try {
        demoBlob = await fetch(url).then(r => r.blob());
        setActiveSource('demo');
      } catch {
        showError('Failed to load demo image.');
      }
    }

    function clearDemoSelection() {
      demoBlob = null;
      demoGrid.querySelectorAll('.demo-thumb.selected').forEach(t => t.classList.remove('selected'));
    }

    function clearDemo() { clearDemoSelection(); }

    // ── Submit ──────────────────────────────────────────────
    const submitBtn    = document.getElementById('submit-btn');
    const btnLabel     = document.getElementById('btn-label');
    const spinner      = document.getElementById('spinner');
    const resultSec    = document.getElementById('result');
    const countNumber  = document.getElementById('count-number');
    const countLabel   = document.getElementById('count-label');
    const resultMeta   = document.getElementById('result-meta');
    const annotatedImg = document.getElementById('annotated-img');
    const errorBox     = document.getElementById('error-box');
    const pillStrip    = document.getElementById('pill-strip');
    const pillStripSec = document.getElementById('pill-strip-section');
    const cropCanvas   = document.getElementById('crop-canvas');

    function setActiveSource(src) {
      activeSource = src;
      submitBtn.disabled = false;
      hideError();
    }

    function clearSubmit() {
      activeSource = null;
      submitBtn.disabled = true;
    }

    submitBtn.addEventListener('click', async () => {
      const imageFile = activeSource === 'upload' ? uploadedFile
                      : activeSource === 'camera' ? capturedBlob
                      : demoBlob;
      if (!imageFile) return;

      setLoading(true);
      hideError();
      resultSec.style.display = 'none';

      const filename = activeSource === 'camera' ? 'capture.jpg'
                     : activeSource === 'demo'   ? 'demo.jpg'
                     : imageFile.name;
      const fd = new FormData();
      fd.append('file', imageFile, filename);

      try {
        const resp = await fetch('/predict', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok) { showError(data.detail || 'Prediction failed'); return; }

        const count = data.count;
        countNumber.textContent = count;
        countLabel.textContent  = count === 1 ? 'pill detected' : 'pills detected';
        annotatedImg.src = data.annotated_image;

        const preds = data.predictions || [];
        if (preds.length > 0) {
          const avg = preds.reduce((s, p) => s + (p.confidence || 0), 0) / preds.length;
          resultMeta.textContent = `avg. confidence ${(avg * 100).toFixed(0)}%`;
        } else {
          resultMeta.textContent = 'No pills detected';
        }

        renderPillStrip(imageFile, preds);

        resultSec.style.display = 'block';
        annotatedImg.onload = () => {
          resultSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
          annotatedImg.onload = null;
        };
        if (annotatedImg.complete) resultSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {
        showError('Network error: ' + e.message);
      } finally {
        setLoading(false);
      }
    });

    // ── Pill strip ──────────────────────────────────────────
    function renderPillStrip(imageFile, predictions) {
      pillStrip.innerHTML = '';
      if (!predictions || predictions.length === 0) {
        pillStripSec.style.display = 'none';
        return;
      }
      const img = new Image();
      img.onload = () => {
        predictions.forEach((pred, i) => {
          const x    = pred.x || 0, y = pred.y || 0;
          const w    = pred.width || 0, h = pred.height || 0;
          const conf = pred.confidence || 0;
          const pad  = Math.max(w, h) * 0.2;
          const sx   = Math.max(0, x - w / 2 - pad);
          const sy   = Math.max(0, y - h / 2 - pad);
          const sw   = Math.min(img.width  - sx, w + pad * 2);
          const sh   = Math.min(img.height - sy, h + pad * 2);

          cropCanvas.width  = sw;
          cropCanvas.height = sh;
          cropCanvas.getContext('2d').drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

          const thumb   = document.createElement('div');
          thumb.className = 'pill-thumb';

          const wrap    = document.createElement('div');
          wrap.className = 'pill-thumb-img-wrap';

          const ti      = document.createElement('img');
          ti.src        = cropCanvas.toDataURL('image/jpeg', 0.85);
          ti.alt        = `Pill ${i + 1}`;

          const confEl  = document.createElement('div');
          confEl.className = 'pill-conf';
          confEl.textContent = `#${i + 1}: ${(conf * 100).toFixed(0)}%`;

          wrap.appendChild(ti);
          thumb.appendChild(wrap);
          thumb.appendChild(confEl);
          pillStrip.appendChild(thumb);
        });
        pillStripSec.style.display = 'block';
      };
      img.src = URL.createObjectURL(imageFile);
    }

    // ── Helpers ─────────────────────────────────────────────
    function setLoading(on) {
      submitBtn.disabled     = on;
      btnLabel.style.display = on ? 'none' : 'inline';
      spinner.style.display  = on ? 'block' : 'none';
    }

    function showError(msg) { errorBox.textContent = msg; errorBox.style.display = 'block'; }
    function hideError()    { errorBox.style.display = 'none'; }

    // ── Init ─────────────────────────────────────────────────
    loadDemoImages();
  </script>
</body>
</html>
